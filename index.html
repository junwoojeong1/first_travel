<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>오사카 여행 — 성인 준우의 첫 여행</title>

<!-- 폰트 -->
<style>
@font-face { font-family: 'FlightSans'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2410-1@1.0/FlightSans-Bold.woff2') format('woff2'); font-weight:700; font-display:swap;}
@font-face { font-family: 'GMarketSans'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff') format('woff'); font-weight:500; font-display:swap;}
@import url('https://cdn.jsdelivr.net/gh/wanteddev/wanted-sans@v1.0.1/packages/wanted-sans/fonts/webfonts/variable/split/WantedSansVariable.min.css');

:root{
  --bg-dark:#0b0f13; --muted:#98a0aa; --accent:#1fb3ff; --accent-2:#2bd4ff; --accent-warm:#ff8c42;
  --max-mobile:420px; --radius:14px;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg-dark);color:#e6f0ff;font-family:'Wanted Sans','WantedSansVariable', "Noto Sans KR", system-ui,-apple-system;}
.container{margin:0 auto;width:100%;max-width:var(--max-mobile);min-height:100vh;display:flex;flex-direction:column;padding-bottom:calc(132px + env(safe-area-inset-bottom));overflow-x:hidden}

/* HERO */
.hero{position:relative;width:100%;height:50vw;min-height:300px;overflow:hidden;border-bottom-left-radius:18px;border-bottom-right-radius:18px;margin-top:10px;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
.hero iframe{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);min-width:100%;min-height:100%;width:auto;height:auto;border:0;pointer-events:none;filter:brightness(0.45) contrast(0.98);z-index:0}
.hero::after{content:"";position:absolute;inset:0;z-index:1;background:linear-gradient(180deg, rgba(6,12,20,0.08), rgba(6,12,20,0.40))}
.hero-inner{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:18px}
.subtitle{font-family:'GMarketSans',sans-serif;font-weight:500;color:rgba(255,255,255,0.92);font-size:0.95rem;background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;margin-bottom:10px}
.title{font-family:'FlightSans','FlightSans-Bold',sans-serif;font-size:2.6rem;font-weight:700;color:#fff;text-shadow:0 12px 36px rgba(10,16,30,0.6);margin:0}
.dates{margin-top:12px;background:rgba(255,255,255,0.04);padding:8px 14px;border-radius:12px;color:var(--muted);font-weight:700}

/* CTA click animation */
.hero-cta{
  margin-top:22px;display:inline-flex;align-items:center;gap:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#01202b;padding:12px 18px;border-radius:999px;font-weight:900;border:0;cursor:pointer;box-shadow:0 10px 30px rgba(31,179,255,0.14);
  transition: transform .18s cubic-bezier(.2,.9,.2,1), box-shadow .18s;
}
.hero-cta:active{ transform: translateY(2px) scale(.99); box-shadow:0 6px 14px rgba(31,179,255,0.08) }

/* Day header */
.day-header{display:flex;align-items:center;justify-content:center;gap:16px;padding:12px 6px;margin-top:14px;position:relative}
.day-arrow{position:absolute;left:8px;top:50%;transform:translateY(-50%);opacity:0.92;background:transparent;border:0;color:var(--muted);font-size:1.05rem;padding:8px;border-radius:10px}
.day-arrow.right{left:auto;right:8px}
.day-arrow:active{transform:translateY(-50%) scale(.96)}
.day-title{font-weight:900;font-size:1.12rem;color:#eaf6ff}
.day-sub{font-size:0.82rem;color:var(--muted);font-weight:700;margin-top:2px}

/* add button */
.add-btn{display:block;margin:8px auto;border-radius:12px;background:linear-gradient(90deg,#2ec2ff,#1fb3ff);padding:12px 18px;color:#01202b;font-weight:900;text-align:center;min-width:220px;box-shadow:0 10px 30px rgba(31,179,255,0.12);cursor:pointer;border:0;transition:transform .12s}
.add-btn:active{transform:translateY(2px) scale(.995)}

/* empty card */
.card-empty{margin-top:18px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;padding:28px 22px;text-align:center;box-shadow:0 18px 48px rgba(2,6,12,0.6);border:1px solid rgba(255,255,255,0.02)}
.card-empty h3{font-size:1.15rem;margin:8px 0 4px 0}
.card-empty p{color:var(--muted);margin:6px 0 14px 0}

/* places list */
.places{margin-top:14px;display:flex;flex-direction:column;gap:12px;padding-bottom:16px}
.place{background: linear-gradient(180deg, rgba(12,16,20,0.6), rgba(12,16,20,0.5));border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px;transition: transform .12s, box-shadow .12s}
.place:active{transform:translateY(1px)}
.place-summary{display:flex;align-items:center;justify-content:space-between;gap:8px}
.place-left{display:flex;gap:12px;align-items:center;min-width:0;flex:1}
.place-name{font-weight:900;color:#e9f6ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.place-type{color:var(--muted);font-weight:800;font-size:0.9rem}
.badge{background:linear-gradient(90deg,var(--accent-2),var(--accent));padding:8px 10px;border-radius:10px;font-weight:900;color:#01202b;min-width:44px;text-align:center}
.place-detail{
  display:block; /* we animate via max-height/opacity */
  max-height:0; overflow:hidden; opacity:0; transition: max-height .28s cubic-bezier(.2,.9,.2,1), opacity .18s ease;
  padding-top:0; margin-top:0; border-top: none;
}
.place.open .place-detail{
  max-height:520px; opacity:1; padding-top:10px; margin-top:10px; border-top:1px dashed rgba(255,255,255,0.03);
}
.input, textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e8f6ff}
.row{display:flex;gap:10px;align-items:center}
.row .label{min-width:70px;font-weight:800;color:var(--muted)}
.range{flex:1}
.small-actions{display:flex;gap:8px;align-items:center}
/* select-day control for moving */
.select-day{min-width:120px;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e8f6ff}

/* bottom bar */
.bottom-bar{position:fixed;left:50%;transform:translateX(-50%);bottom:0;z-index:200;width:100%;max-width:var(--max-mobile);padding:12px calc(14px + env(safe-area-inset-left)) calc(12px + env(safe-area-inset-bottom)) calc(14px + env(safe-area-inset-right));display:flex;gap:10px;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(6,10,16,0.92), rgba(6,10,16,0.98));border-top:1px solid rgba(255,255,255,0.02)}
.save-btn{background:linear-gradient(90deg,var(--accent-2),var(--accent));padding:12px 18px;border-radius:12px;border:0;font-weight:900;color:#01202b;cursor:pointer;min-width:110px;transition:transform .12s}
.save-btn:active{transform:scale(.99)}
.export-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px 12px;border-radius:12px;color:var(--muted);font-weight:800;cursor:pointer}
.import-label{background:transparent;border:1px dashed rgba(255,255,255,0.04);padding:10px 12px;border-radius:12px;color:var(--muted);font-weight:800;cursor:pointer}

/* small responsive */
@media(min-width:900px){ .container{max-width:960px} .title{font-size:3.4rem} .hero{height:56vh;border-radius:20px} }
</style>
</head>
<body>
  <div class="container" id="app">
    <!-- HERO -->
    <header class="hero" role="banner" aria-label="오사카 야경">
      <iframe id="bgVideo" src="https://www.youtube.com/embed/G5RpJwCJDqc?autoplay=1&mute=1&controls=0&loop=1&playlist=G5RpJwCJDqc&modestbranding=1&playsinline=1" allow="autoplay; fullscreen; picture-in-picture"></iframe>
      <div class="hero-inner">
        <div class="subtitle">성인 준우의 첫 여행</div>
        <h1 class="title">오사카 여행</h1>
        <div class="dates">2025.12.6. — 2025.12.13</div>
        <button class="hero-cta" id="startPlanBtn">여행 시작하기 →</button>
      </div>
    </header>

    <!-- Day header -->
    <div class="day-header" role="navigation" aria-label="Day navigation">
      <button class="day-arrow" id="prevDay">◀</button>
      <div style="text-align:center">
        <div class="day-title" id="dayTitle">Day 0</div>
        <div class="day-sub" id="dayDate">전체 일정</div>
      </div>
      <button class="day-arrow right" id="nextDay">▶</button>
    </div>

    <button class="add-btn" id="addTopBtn">＋ 장소 추가하기</button>

    <main>
      <section class="day-card">
        <div id="placesRoot">
          <div class="card-empty" id="emptyCard" style="display:none">
            <div style="width:72px;height:72px;margin:0 auto;border-radius:50%;background:rgba(31,179,255,0.06);display:flex;align-items:center;justify-content:center;">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" stroke="#1fb3ff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <h3>장소가 없습니다</h3>
            <p>첫 장소를 추가해보세요 ✨</p>
            <button class="small-add" id="emptyAddBtn">＋ 장소 추가하기</button>
          </div>

          <div class="places" id="placesList"></div>
        </div>
      </section>
    </main>

    <button class="add-btn" id="addBottomBtn" style="margin-bottom:16px">＋ 장소 추가하기</button>

    <footer style="text-align:center;color:var(--muted);padding:10px 0 60px 0;font-weight:700">저장: 로컬 · GitHub Pages 배포 가능</footer>
  </div>

  <!-- bottom bar -->
  <div class="bottom-bar" role="region" aria-label="하단 바">
    <button id="saveBtn" class="save-btn" title="현재 Day 저장">저장</button>
    <button id="exportBtn" class="export-btn">내보내기 (JSON)</button>
    <label class="import-label">불러오기 <input id="importFile" type="file" accept="application/json" style="display:none"></label>
    <div style="width:8px"></div>
    <div id="statusText" style="color:var(--muted);font-weight:800">변경 사항 없음</div>
  </div>

<script>
/* 전체 스크립트
 - Day 0 추가 (index 0)
 - Days: 0..9 (0은 전체 보기)
 - 장소 이동: 상세에서 select-day로 다른 Day 지정 가능 -> 즉시 저장(자동)
 - 애니메이션: .place.open 트랜지션으로 부드럽게 전개/축소
 - 저장/내보내기/불러오기 유지
*/

const TOTAL_DAYS = 9; // 1..9 실제 여행일
// accessibleDayIndices = [0,1..9]
let currentDay = 0; // default to Day 0 (전체 뷰)
const dayLabels = ['전체 일정','12월 6일','12월 7일','12월 8일','12월 9일','12월 10일','12월 11일','12월 12일','12월 13일','12월 14일'];

// DOM refs
const dayTitle = document.getElementById('dayTitle');
const dayDate = document.getElementById('dayDate');
const prevDay = document.getElementById('prevDay');
const nextDay = document.getElementById('nextDay');
const addTopBtn = document.getElementById('addTopBtn');
const addBottomBtn = document.getElementById('addBottomBtn');
const emptyAddBtn = document.getElementById('emptyAddBtn');
const placesList = document.getElementById('placesList');
const emptyCard = document.getElementById('emptyCard');
const saveBtn = document.getElementById('saveBtn');
const exportBtn = document.getElementById('exportBtn');
const importFile = document.getElementById('importFile');
const statusText = document.getElementById('statusText');
const startPlanBtn = document.getElementById('startPlanBtn');

function storageKey(d){ return 'osaka_day_' + d; }

// Ensure storage exists for days 1..9
for(let i=1;i<=TOTAL_DAYS;i++){
  if(!localStorage.getItem(storageKey(i))) localStorage.setItem(storageKey(i), JSON.stringify({places:[]}));
}

// utils load/save for single day (1..9)
function loadDay(d){
  if(d < 1 || d > TOTAL_DAYS) return { places: [] };
  try{ return JSON.parse(localStorage.getItem(storageKey(d))) || {places:[]} }catch(e){ return {places:[]} }
}
function saveDay(data, d){
  if(d < 1 || d > TOTAL_DAYS) return;
  localStorage.setItem(storageKey(d), JSON.stringify(data));
}

// All places aggregate (for Day 0)
function loadAllPlaces(){
  const all = [];
  for(let d=1; d<=TOTAL_DAYS; d++){
    const day = loadDay(d);
    (day.places || []).forEach(p => {
      all.push({...p, _day: d});
    });
  }
  return all;
}

// Place factory
function newPlace(){
  return { id:'p_'+Date.now()+Math.floor(Math.random()*1000), name:'', type:'', location:3, price:3, charm:3, memo:'', moveToNext:'', _day: null };
}

// status
function setStatus(txt){
  statusText.textContent = txt;
  if(txt === '변경 사항 없음') saveBtn.classList.remove('active'); else saveBtn.classList.add('active');
}

// rendering
function render(){
  // header
  dayTitle.textContent = currentDay === 0 ? 'Day 0' : 'Day ' + currentDay;
  dayDate.textContent = dayLabels[currentDay] || '';

  // compute which items to show
  let items = [];
  if(currentDay === 0){
    items = loadAllPlaces();
  } else {
    const d = loadDay(currentDay);
    items = (d.places || []).map(p => ({...p, _day: currentDay}));
  }

  placesList.innerHTML = '';
  if(!items || items.length === 0){
    emptyCard.style.display = 'block';
    return;
  } else {
    emptyCard.style.display = 'none';
  }

  // restaurant detection for lunch/dinner tag — applied per day's rendering in Day-specific view; for Day0, show original day
  items.forEach((p, idx) => {
    const el = document.createElement('div'); el.className = 'place'; el.dataset.id = p.id;
    const sum = document.createElement('div'); sum.className = 'place-summary';
    const left = document.createElement('div'); left.className = 'place-left';
    const badge = document.createElement('div'); badge.className = 'badge'; badge.textContent = p.charm || 3;
    const info = document.createElement('div');
    const name = document.createElement('div'); name.className = 'place-name'; name.textContent = p.name || '무제 장소';
    const type = document.createElement('div'); type.className = 'place-type'; type.textContent = p.type || '종류 미지정';
    info.appendChild(name); info.appendChild(type);
    left.appendChild(badge); left.appendChild(info);

    // If aggregated view, show origin day chip
    if(currentDay === 0){
      const dayChip = document.createElement('div'); dayChip.className = 'place-type'; dayChip.style.marginLeft='8px'; dayChip.style.color='#ffd7b2';
      dayChip.textContent = `Day ${p._day}`;
      left.appendChild(dayChip);
    }

    const right = document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';
    const dot = document.createElement('div'); dot.className = 'chev'; dot.textContent = '⋯';
    right.appendChild(dot);
    sum.appendChild(left); sum.appendChild(right);

    // detail block (animated)
    const detail = document.createElement('div'); detail.className = 'place-detail';

    // inputs
    const inputName = document.createElement('input'); inputName.className='input'; inputName.placeholder='장소명'; inputName.value = p.name || '';
    const inputType = document.createElement('input'); inputType.className='input'; inputType.placeholder='장소 종류 (예: 음식점, 디저트, 관광지)'; inputType.value = p.type || '';
    const rowLoc = document.createElement('div'); rowLoc.className='row';
    const labelLoc = document.createElement('div'); labelLoc.className='label'; labelLoc.textContent = '위치';
    const rangeLoc = document.createElement('input'); rangeLoc.type='range'; rangeLoc.min=1; rangeLoc.max=5; rangeLoc.value=p.location || 3; rangeLoc.className='range';
    const rowPrice = document.createElement('div'); rowPrice.className='row';
    const labelPrice = document.createElement('div'); labelPrice.className='label'; labelPrice.textContent='가격';
    const rangePrice = document.createElement('input'); rangePrice.type='range'; rangePrice.min=1; rangePrice.max=5; rangePrice.value=p.price || 3; rangePrice.className='range';
    const rowCharm = document.createElement('div'); rowCharm.className='row';
    const labelCharm = document.createElement('div'); labelCharm.className='label'; labelCharm.textContent='종합 매력';
    const rangeCharm = document.createElement('input'); rangeCharm.type='range'; rangeCharm.min=1; rangeCharm.max=5; rangeCharm.value=p.charm || 3; rangeCharm.className='range';
    const memo = document.createElement('textarea'); memo.className='input'; memo.placeholder='기타 메모'; memo.value = p.memo || '';

    // 이동시간 카테고리 (30/60/120/240)
    const moveRow = document.createElement('div'); moveRow.className='row';
    const moveLabel = document.createElement('div'); moveLabel.className='label'; moveLabel.textContent = '이동시간';
    const moveSelect = document.createElement('select'); moveSelect.className='input';
    const travelOptions = [
      {val:'', label:'미지정'},
      {val:'30', label:'30분 이하'},
      {val:'60', label:'1시간 이하'},
      {val:'120', label:'2시간 이하'},
      {val:'240', label:'2시간 이상'}
    ];
    travelOptions.forEach(opt=>{
      const o = document.createElement('option'); o.value = opt.val; o.textContent = opt.label;
      if(String(p.moveToNext) === String(opt.val)) o.selected = true;
      moveSelect.appendChild(o);
    });
    moveRow.appendChild(moveLabel); moveRow.appendChild(moveSelect);

    // day selector (for moving between days) — show in both aggregated and single-day views
    const dayRow = document.createElement('div'); dayRow.className = 'row';
    const dayLabel = document.createElement('div'); dayLabel.className = 'label'; dayLabel.textContent = 'Assigned';
    const daySelect = document.createElement('select'); daySelect.className = 'select-day';
    const option0 = document.createElement('option'); option0.value = 0; option0.textContent = 'Day 0 (전체)';
    daySelect.appendChild(option0);
    for(let d=1; d<=TOTAL_DAYS; d++){
      const opt = document.createElement('option'); opt.value = d; opt.textContent = 'Day ' + d;
      daySelect.appendChild(opt);
    }
    // set current selection
    const assigned = (currentDay === 0) ? (p._day || 1) : p._day || currentDay;
    daySelect.value = assigned;
    dayRow.appendChild(dayLabel); dayRow.appendChild(daySelect);

    // action buttons
    const actions = document.createElement('div'); actions.className = 'small-actions';
    const deleteBtn = document.createElement('button'); deleteBtn.textContent = '삭제';
    const upBtn = document.createElement('button'); upBtn.textContent = '▲';
    const downBtn = document.createElement('button'); downBtn.textContent = '▼';
    // quick-jump to its day button (works in aggregated view)
    const gotoBtn = document.createElement('button'); gotoBtn.textContent = '해당일로 이동';
    actions.appendChild(gotoBtn); actions.appendChild(deleteBtn); actions.appendChild(upBtn); actions.appendChild(downBtn);

    // assemble detail (order)
    detail.appendChild(inputName);
    detail.appendChild(inputType);
    rowLoc.appendChild(labelLoc); rowLoc.appendChild(rangeLoc);
    rowPrice.appendChild(labelPrice); rowPrice.appendChild(rangePrice);
    rowCharm.appendChild(labelCharm); rowCharm.appendChild(rangeCharm);
    detail.appendChild(rowLoc); detail.appendChild(rowPrice); detail.appendChild(rowCharm);
    detail.appendChild(memo);
    detail.appendChild(moveRow);
    detail.appendChild(dayRow);
    detail.appendChild(actions);

    // toggle detail with smooth animation
    sum.addEventListener('click', ()=>{
      const was = el.classList.toggle('open');
      if(was){
        // scroll into view subtly
        setTimeout(()=> el.scrollIntoView({behavior:'smooth', block:'center'}), 160);
      }
    });

    // mark dirty on change
    [inputName,inputType,rangeLoc,rangePrice,rangeCharm,memo,moveSelect,daySelect].forEach(inp=>{
      inp.addEventListener('input', ()=> {
        el.dataset.dirty = '1';
        setStatus('저장 필요 — 변경 사항 있음');
      });
      daySelect.addEventListener('change', ()=> {
        // moving between days
        const targetDay = Number(daySelect.value);
        movePlaceToDay(p.id, p._day || currentDay, targetDay);
      });
    });

    // goto day (aggregated view)
    gotoBtn.addEventListener('click', ()=>{
      const target = p._day || currentDay;
      if(target >=1 && target <= TOTAL_DAYS){
        currentDay = target;
        render();
        // small hero of target day: scroll up
        window.scrollTo({top:0, behavior:'smooth'});
      } else {
        alert('이 항목은 특정 날짜에 할당되지 않았습니다.');
      }
    });

    // delete / up / down operations (operates on assigned day)
    deleteBtn.addEventListener('click', ()=>{
      if(!confirm('삭제하시겠습니까?')) return;
      const fromDay = p._day || currentDay;
      deletePlaceFromDay(p.id, fromDay);
    });
    upBtn.addEventListener('click', ()=>{
      const dayIndex = p._day || currentDay;
      movePlacePosition(p.id, dayIndex, -1);
    });
    downBtn.addEventListener('click', ()=>{
      const dayIndex = p._day || currentDay;
      movePlacePosition(p.id, dayIndex, 1);
    });

    // append
    el.appendChild(sum); el.appendChild(detail);
    placesList.appendChild(el);

    // show short move label in summary
    const shortMove = document.createElement('div'); shortMove.style.fontSize='0.86rem'; shortMove.style.color='var(--muted)';
    const mv = p.moveToNext || '';
    const label = ({'30':'30분 이하','60':'1시간 이하','120':'2시간 이하','240':'2시간 이상'})[mv] || '';
    if(label) shortMove.textContent = `이동: ${label}`;
    sum.appendChild(shortMove);
  });
}

// move place to other day
function movePlaceToDay(placeId, fromDay, toDay){
  if(fromDay === toDay) return;
  // find and remove from fromDay (if fromDay is 0 -> search all days)
  let found = null;
  if(fromDay === 0){
    // find where it currently is
    for(let d=1; d<=TOTAL_DAYS; d++){
      const day = loadDay(d);
      const idx = (day.places || []).findIndex(x=>x.id===placeId);
      if(idx > -1){
        found = { day:d, idx, place: day.places[idx] };
        day.places.splice(idx,1);
        saveDay(day, d);
        break;
      }
    }
  } else {
    const day = loadDay(fromDay);
    const idx = (day.places || []).findIndex(x=>x.id===placeId);
    if(idx > -1){
      found = { day: fromDay, idx, place: day.places[idx] };
      day.places.splice(idx,1);
      saveDay(day, fromDay);
    }
  }
  // if not found in fromDay, try search all
  if(!found){
    for(let d=1; d<=TOTAL_DAYS; d++){
      const day = loadDay(d);
      const idx = (day.places || []).findIndex(x=>x.id===placeId);
      if(idx > -1){
        found = { day:d, idx, place: day.places[idx] };
        day.places.splice(idx,1);
        saveDay(day, d);
        break;
      }
    }
  }

  if(!found){
    alert('해당 장소를 찾을 수 없습니다.');
    return;
  }

  // add to toDay (if toDay===0 -> push to Day1 by default)
  const destDay = (toDay === 0) ? 1 : toDay;
  const dest = loadDay(destDay);
  const place = found.place;
  // update assigned field if present
  place._day = destDay;
  dest.places = dest.places || [];
  dest.places.push(place);
  saveDay(dest, destDay);
  setStatus('저장됨 — 날짜 이동 완료');
  // if currently viewing either fromDay or toDay or Day0, re-render
  if(currentDay === 0 || currentDay === found.day || currentDay === destDay) render();
}

// delete from day helper
function deletePlaceFromDay(placeId, fromDay){
  for(let d=1; d<=TOTAL_DAYS; d++){
    const day = loadDay(d);
    const idx = (day.places || []).findIndex(x=>x.id===placeId);
    if(idx > -1){
      day.places.splice(idx,1);
      saveDay(day,d);
      setStatus('저장됨 — 삭제됨');
      render();
      return;
    }
  }
  alert('삭제 실패: 항목을 찾을 수 없음');
}

// move position up/down in same day
function movePlacePosition(placeId, dayIndex, direction){
  const day = loadDay(dayIndex);
  const idx = (day.places || []).findIndex(x=>x.id===placeId);
  if(idx === -1) return;
  const newIdx = idx + direction;
  if(newIdx < 0 || newIdx >= day.places.length) return;
  const [it] = day.places.splice(idx,1);
  day.places.splice(newIdx,0,it);
  saveDay(day, dayIndex);
  setStatus('저장됨 — 순서 변경');
  render();
}

// Add actions
function addPlaceToDay(targetDay, atTop=false){
  const p = newPlace();
  const day = loadDay(targetDay);
  p._day = targetDay;
  day.places = day.places || [];
  if(atTop) day.places.unshift(p); else day.places.push(p);
  saveDay(day, targetDay);
  setStatus('저장됨');
  render();
}

addTopBtn.addEventListener('click', ()=>{
  if(currentDay === 0){
    // default to Day1
    addPlaceToDay(1, true);
  } else {
    addPlaceToDay(currentDay, true);
  }
});
addBottomBtn.addEventListener('click', ()=>{
  if(currentDay === 0) addPlaceToDay(1,false); else addPlaceToDay(currentDay,false);
});
if(emptyAddBtn) emptyAddBtn.addEventListener('click', ()=> { if(currentDay===0) addPlaceToDay(1,false); else addPlaceToDay(currentDay,false); });

// navigation prev / next (wrap between 0..TOTAL_DAYS)
prevDay.addEventListener('click', ()=> {
  currentDay = (currentDay - 1 + (TOTAL_DAYS+1)) % (TOTAL_DAYS+1);
  render();
});
nextDay.addEventListener('click', ()=> {
  currentDay = (currentDay + 1) % (TOTAL_DAYS+1);
  render();
});

// "startPlanBtn" jumps to Day1
startPlanBtn.addEventListener('click', ()=> { currentDay = 1; render(); window.scrollTo({top:0,behavior:'smooth'}); });

// Global save: persist current day's DOM values into storage if currentDay != 0, if Day0 we choose to write changes by assigning via select or to specific day
saveBtn.addEventListener('click', ()=>{
  if(currentDay === 0){
    // For Day0 we will iterate each place DOM and update its assigned day (if changed)
    // But because Day0 items may represent different days, safer approach is to apply changes using movePlaceToDay when select changed already handled.
    // So here we just set status and re-render.
    setStatus('변경 사항 없음');
    render();
    return;
  }
  // read DOM places and write into currentDay storage
  const placeEls = document.querySelectorAll('.place');
  const newPlaces = [];
  placeEls.forEach(el=>{
    // find field values in detail (if closed, we keep original saved value by reading storage)
    const pId = el.dataset.id;
    let original = loadDay(currentDay).places.find(x=>x.id === pId) || {id:pId};
    const nameInput = el.querySelector('input[type="text"]');
    // in our markup, there are two text inputs — but easier to select via querySelectorAll
    const textInputs = el.querySelectorAll('input[type="text"]');
    const name = textInputs[0] ? textInputs[0].value.trim() : (original.name || '');
    const type = textInputs[1] ? textInputs[1].value.trim() : (original.type || '');
    const ranges = el.querySelectorAll('input[type="range"]');
    const loc = ranges[0] ? Number(ranges[0].value) : (original.location || 3);
    const price = ranges[1] ? Number(ranges[1].value) : (original.price || 3);
    const charm = ranges[2] ? Number(ranges[2].value) : (original.charm || 3);
    const memo = el.querySelector('textarea') ? el.querySelector('textarea').value : (original.memo || '');
    const moveSel = el.querySelector('select') ? el.querySelector('select').value : (original.moveToNext || '');
    newPlaces.push({ id:pId, name, type, location:loc, price:price, charm:charm, memo:memo, moveToNext: moveSel });
  });
  // save newPlaces
  saveDay({places: newPlaces}, currentDay);
  setStatus('저장됨');
  render();
});

// Export / Import
exportBtn.addEventListener('click', ()=> {
  const dump = {};
  for(let d=1; d<=TOTAL_DAYS; d++){
    dump['Day'+d] = loadDay(d);
  }
  const blob = new Blob([JSON.stringify(dump, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'osaka_trip_export.json'; a.click(); URL.revokeObjectURL(url);
});
importFile.addEventListener('change', (e)=> {
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = (ev)=> {
    try{
      const obj = JSON.parse(ev.target.result);
      let found=false;
      for(let d=1; d<=TOTAL_DAYS; d++){
        if(obj['Day'+d]){ saveDay(obj['Day'+d], d); found=true; }
      }
      if(!found && Array.isArray(obj.places)){ saveDay({places: obj.places}, currentDay); found=true; }
      if(found){ alert('불러오기 완료'); setStatus('변경 사항 없음'); render(); } else alert('파일 형식이 올바르지 않습니다.');
    }catch(err){ alert('파일 읽기 실패'); console.error(err); }
  };
  r.readAsText(f);
  e.target.value = '';
});

// initial render
render();
setStatus('변경 사항 없음');

</script>
</body>
</html>
